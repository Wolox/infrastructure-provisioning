variable "bucket_name" {}
variable "acl" {}
variable "has_policy" {}

data "template_file" "init" {
    template = "${file("${var.bucket_name}.tpl")}"

    vars {
        bucket_name = "${var.bucket_name}"
    }
}

resource "aws_s3_bucket" "b" {
    bucket = "${var.bucket_name}"
    acl = "${var.acl}"
    policy = "${var.has_policy ? data.template_file.init.rendered : ""}"

  <% if @public_website %>
    cors_rule {
      allowed_headers = ["Authorization"]
      allowed_methods = ["GET"]
      allowed_origins = ["*"]
      max_age_seconds = 3000
    }

  <% end %>
    website {
      index_document = "index.html"
      error_document = "error.html"

      routing_rules = <<EOF
[{
  "Condition": {
    "HttpErrorCodeReturnedEquals":"404"
  },
  "Redirect": {
    "HostName": "${var.bucket_name}",
    "ReplaceKeyPrefixWith":"#"
  }
}]
EOF
}
}
